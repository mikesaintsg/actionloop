<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>@mikesaintsg/actionloop Showcase</title>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class p extends Error{code;nodeId;transitionKey;sessionId;cause;constructor(t,e,s){super(e),this.name="ActionLoopError",this.code=t,s?.nodeId!==void 0&&(this.nodeId=s.nodeId),s?.transitionKey!==void 0&&(this.transitionKey=s.transitionKey),s?.sessionId!==void 0&&(this.sessionId=s.sessionId),s?.cause!==void 0&&(this.cause=s.cause),"captureStackTrace"in Error&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,p)}}const Z=18e5,x=.9,F=.001,tt=864e5,U=5,et=50,st=10,it=2,ot=5,nt=10,rt=5e3,at=5,ct=3e4,dt=3e5,H={active:1,idle:.3},lt=10,ht=5,ut=3e4,ft=.1,gt=1,pt=10,mt=100,M=1;function L(){const n=Date.now().toString(36),t=Math.random().toString(36).substring(2,10);return`${n}-${t}`}function b(n,t){return`${n}->${t}`}function E(n,t,e){return`${n}::${t}::${e}`}function y(n){if(n===null||typeof n!="object")return n;Object.freeze(n);for(const t of Object.keys(n)){const e=n[t];e!==null&&typeof e=="object"&&!Object.isFrozen(e)&&y(e)}return n}function v(){return Date.now()}function vt(n){let t=0,e=!1,s="";for(const i of n)if(e)i===s&&(e=!1);else if(i==='"'||i==="'")e=!0,s=i;else if(i==="(")t++;else if(i===")"&&(t--,t<0))return!1;return t===0&&!e}function R(n){return n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1):/^-?\d+(\.\d+)?$/.test(n)?parseFloat(n):n==="true"?!0:n==="false"?!1:n}class q{#t;#e;#s;#i;#o;#n;#d;constructor(t){if(this.#t=new Map,this.#e=new Map,this.#s=new Map,this.#i=new Map,this.#o=new Map,this.#n=new Set,this.#d=t.version,t.onValidation&&this.#n.add(t.onValidation),t.nodes)for(const e of t.nodes)this.#a(e);for(const e of t.transitions)this.#r(e);if(t.procedures)for(const e of t.procedures)this.#c(e);if(t.validateOnCreate!==!1){const s=this.validate().filter(o=>o.severity==="error"),i=s[0];if(i)throw new p("BUILD_FAILED",`Procedural graph validation failed with ${s.length} error(s): ${i.message}`)}}#a(t){const e=y(Object.assign({id:t.id},t.label!==void 0?{label:t.label}:{},t.type!==void 0?{type:t.type}:{},t.metadata!==void 0?{metadata:t.metadata}:{}));this.#t.set(e.id,e),this.#s.has(e.id)||this.#s.set(e.id,new Set),this.#i.has(e.id)||this.#i.set(e.id,new Set)}#r(t){this.#t.has(t.from)||this.#a({id:t.from}),this.#t.has(t.to)||this.#a({id:t.to});const e=b(t.from,t.to),s=y(Object.assign({from:t.from,to:t.to,weight:t.weight,actor:t.actor},t.metadata!==void 0?{metadata:t.metadata}:{}));this.#e.set(e,s),this.#s.get(t.from)?.add(t.to),this.#i.get(t.to)?.add(t.from)}#c(t){const e=y(Object.assign({id:t.id,actions:t.actions},t.metadata!==void 0?{metadata:t.metadata}:{}));this.#o.set(e.id,e)}getNode(t){return this.#t.get(t)}getNodes(){return Array.from(this.#t.values())}hasNode(t){return this.#t.has(t)}getTransitions(t){const e=this.#s.get(t);if(!e)return[];const s=[];for(const i of e){const o=b(t,i),r=this.#e.get(o);r&&s.push(r)}return s}getTransitionsTo(t){const e=this.#i.get(t);if(!e)return[];const s=[];for(const i of e){const o=b(i,t),r=this.#e.get(o);r&&s.push(r)}return s}getAllTransitions(){return Array.from(this.#e.values())}hasTransition(t,e){const s=b(t,e);return this.#e.has(s)}getTransition(t,e){const s=b(t,e);return this.#e.get(s)}getProcedure(t){return this.#o.get(t)}getProcedures(){return Array.from(this.#o.values())}hasProcedure(t){return this.#o.has(t)}getStats(){const t={user:0,system:0,automation:0};for(const e of this.#e.values())t[e.actor]++;return y({nodeCount:this.#t.size,transitionCount:this.#e.size,procedureCount:this.#o.size,actorCounts:t})}isStartNode(t){const e=this.#i.get(t);return e===void 0||e.size===0}isEndNode(t){const e=this.#s.get(t);return e===void 0||e.size===0}getStartNodes(){const t=[];for(const[e,s]of this.#i)s.size===0&&t.push(e);return t}getEndNodes(){const t=[];for(const[e,s]of this.#s)s.size===0&&t.push(e);return t}getVersion(){return this.#d}validate(){const t=[];for(const[s,i]of this.#s)if(i.size===0){const o=this.#i.get(s);o&&o.size>0&&t.push({passed:!1,message:`Node '${s}' has no outgoing transitions (dead end)`,severity:"warning",suggestion:"Add outgoing transitions or mark as terminal node",nodeId:s})}this.getStartNodes().length===0&&this.#t.size>0&&t.push({passed:!1,message:"No start nodes found (all nodes have incoming transitions)",severity:"warning",suggestion:"Ensure at least one node has no incoming transitions"});for(const s of this.#t.keys()){const i=this.#i.get(s),o=this.#s.get(s);(!i||i.size===0)&&(!o||o.size===0)&&t.push({passed:!1,message:`Node '${s}' is isolated (no connections)`,severity:"error",suggestion:"Connect this node or remove it",nodeId:s})}for(const s of this.#o.values())for(const i of s.actions)this.#t.has(i)||t.push({passed:!1,message:`Procedure '${s.id}' references unknown node '${i}'`,severity:"error",suggestion:`Add node '${i}' or remove from procedure`});for(const s of this.#n)s(t);return t}isValid(){return this.validate().every(e=>e.severity!=="error")}onValidation(t){return this.#n.add(t),()=>{this.#n.delete(t)}}export(){return y({version:M,exportedAt:v(),nodes:this.getNodes(),transitions:this.getAllTransitions(),procedures:this.getProcedures()})}destroy(){this.#n.clear()}}class yt{#t;#e;#s;#i;#o;#n;#d;#a;#r;#c;#l;constructor(t,e={}){this.#t=t,this.#e=new Map,this.#s=L(),this.#o=e.minWeight??F,this.#c=0,this.#l=v(),this.#n=e.coldStart?.warmupThreshold??100,this.#d=e.persistence,this.#i=y(Object.assign({algorithm:e.decayAlgorithm??"ewma",decayFactor:e.decayFactor??x,minWeight:this.#o},e.halfLifeMs!==void 0?{halfLifeMs:e.halfLifeMs}:{})),this.#a=new Set,this.#r=new Set,e.onWeightUpdate&&this.#a.add(e.onWeightUpdate),e.onDecay&&this.#r.add(e.onDecay),e.coldStart?.preloadRecords&&this.preload(e.coldStart.preloadRecords)}#h(t,e){const s=e-t.lastUpdated;switch(this.#i.algorithm){case"halflife":{const i=this.#i.halfLifeMs??tt,o=Math.pow(.5,s/i);return Math.max(t.weight*o,this.#o)}case"ewma":{const i=this.#i.decayFactor??x,o=Math.floor(s/36e5);if(o===0)return t.weight;const r=Math.pow(i,o);return Math.max(t.weight*r,this.#o)}case"linear":{const i=F,o=s/36e5;return Math.max(t.weight-i*o,this.#o)}default:return t.weight}}getWeight(t,e,s){if(!this.#t.hasTransition(t,e))return 0;const i=E(t,e,s),o=this.#e.get(i);return o?this.#h(o,v()):0}getWeights(t,e){const s=this.#t.getTransitions(t),i=v(),o=[];for(const r of s){const c=E(t,r.to,e),l=this.#e.get(c),a=l?this.#h(l,i):0;o.push({to:r.to,weight:r.weight+a,baseWeight:r.weight,predictiveWeight:a})}return o.sort((r,c)=>c.weight-r.weight),o}getModelId(){return this.#s}getDecayConfig(){return this.#i}getStats(){const t=this.#t.getStats();return y({...t,totalWeightUpdates:this.#c,lastUpdateTime:this.#l,modelId:this.#s,warmupComplete:this.isWarmupComplete()})}hasWeight(t,e,s){const i=E(t,e,s);return this.#e.has(i)}getTransitionCount(){return this.#c}isWarmupComplete(){return this.#c>=this.#n}updateWeight(t,e,s){if(!this.#t.hasTransition(t,e))throw new p("INVALID_TRANSITION",`Cannot update weight for invalid transition: ${t} -> ${e}`,{transitionKey:`${t}::${e}`});const i=E(t,e,s),o=v(),r=this.#e.get(i);let c;r?c=this.#h(r,o)+1:c=1,this.#e.set(i,{weight:c,lastUpdated:o,updateCount:(r?.updateCount??0)+1}),this.#c++,this.#l=o;for(const l of this.#a)l(t,e,s,c)}updateWeightWithEngagement(t,e,s,i){if(!this.#t.hasTransition(t,e))throw new p("INVALID_TRANSITION",`Cannot update weight for invalid transition: ${t} -> ${e}`,{transitionKey:`${t}::${e}`});const o=E(t,e,s),r=v(),c=this.#e.get(o),l=Math.max(ft,Math.min(gt,i));let a;c?a=this.#h(c,r)+l:a=l,this.#e.set(o,{weight:a,lastUpdated:r,updateCount:(c?.updateCount??0)+1}),this.#c++,this.#l=r;for(const u of this.#a)u(t,e,s,a)}setWeight(t,e,s,i){if(!this.#t.hasTransition(t,e))throw new p("INVALID_TRANSITION",`Cannot set weight for invalid transition: ${t} -> ${e}`,{transitionKey:`${t}::${e}`});const o=E(t,e,s),r=v(),c=this.#e.get(o);this.#e.set(o,{weight:Math.max(i,this.#o),lastUpdated:r,updateCount:(c?.updateCount??0)+1}),this.#l=r;for(const l of this.#a)l(t,e,s,i)}applyDecay(){const t=v();let e=0;for(const[s,i]of this.#e){const o=this.#h(i,t);o<this.#o?(this.#e.delete(s),e++):o!==i.weight&&(this.#e.set(s,{weight:o,lastUpdated:t,updateCount:i.updateCount}),e++)}for(const s of this.#r)s(e);return e}clear(){this.#e.clear(),this.#c=0}clearActor(t){const e=[];for(const s of this.#e.keys())s.endsWith(`::${t}`)&&e.push(s);for(const s of e)this.#e.delete(s)}preload(t){const e=v();for(const s of t){if(!this.#t.hasTransition(s.from,s.to))continue;const i=E(s.from,s.to,s.actor),o=this.#e.get(i);this.#e.set(i,{weight:(o?.weight??0)+s.count,lastUpdated:e,updateCount:(o?.updateCount??0)+s.count})}}onWeightUpdate(t){return this.#a.add(t),()=>{this.#a.delete(t)}}onDecay(t){return this.#r.add(t),()=>{this.#r.delete(t)}}export(){const t=[];for(const[e,s]of this.#e){const i=e.split("::"),o=i[0],r=i[1],c=i[2];i.length===3&&o&&r&&c&&t.push({from:o,to:r,actor:c,weight:s.weight,lastUpdated:s.lastUpdated,updateCount:s.updateCount})}return y({version:M,exportedAt:v(),modelId:this.#s,weights:t,decayConfig:this.#i,transitionCount:this.#c,warmupThreshold:this.#n})}import(t){if(t.version!==M)throw new p("MODEL_MISMATCH",`Incompatible model version: expected ${M}, got ${t.version}`);this.clear();for(const e of t.weights){const s=E(e.from,e.to,e.actor);this.#e.set(s,{weight:e.weight,lastUpdated:e.lastUpdated,updateCount:e.updateCount})}}async saveWeights(){if(!this.#d)throw new p("PERSISTENCE_FAILED","Cannot save weights: no persistence adapter configured");const t=this.export();await this.#d.save(t)}async loadWeights(){if(!this.#d||!await this.#d.isAvailable())return!1;const e=await this.#d.load(this.#s);return e?(this.import(e),!0):!1}destroy(){this.#a.clear(),this.#r.clear(),this.#e.clear()}}class wt{#t;#e;#s;#i;#o;#n;#d;#a;#r;#c;#l;#h;#u;#f;constructor(t,e,s={}){this.#t=t,this.#e=e,this.#s=new Map,this.#i=new Map,this.#o=s.validateTransitions!==!1,this.#n=s.trackSessions!==!1,this.#d=s.sessionTimeoutMs??Z,this.#a=s.activity,this.#r=s.eventPersistence,this.#c=new Set,this.#l=new Set,this.#h=new Set,this.#u=new Set,this.#f=new Set,s.onTransition&&this.#c.add(s.onTransition),s.onPrediction&&this.#l.add(s.onPrediction),s.onSessionStart&&this.#h.add(s.onSessionStart),s.onSessionEnd&&this.#u.add(s.onSessionEnd),s.onError&&this.#f.add(s.onError)}#g(t){for(const e of this.#f)e(t)}#p(t,e,s){const i=this.#s.get(t);if(!i?.active)return;const o=v(),r=i.events[i.events.length-1],c={id:L(),sessionId:t,actor:i.info.actor,from:e,to:s,timestamp:o,duration:r?o-r.timestamp:0,sessionElapsed:o-i.info.startTime,eventType:"transition"};i.events.push(c);const l={...i.info,lastActivity:o,nodeHistory:[...i.info.nodeHistory??[],s]};i.info=l}recordTransition(t,e,s){if(this.#o&&!this.#t.hasTransition(t,e)){const i=new p("INVALID_TRANSITION",`Transition not allowed: ${t} -> ${e}`,{transitionKey:`${t}::${e}`});throw this.#g(i),i}this.#e.updateWeight(t,e,s.actor),this.#n&&s.sessionId&&this.#p(s.sessionId,t,e);for(const i of this.#c)i(t,e,s)}recordTransitions(t){for(const{from:e,to:s,context:i}of t)this.recordTransition(e,s,i)}predictNext(t,e){const s=e.count??U,o=this.#e.getWeights(t,e.actor).slice(0,s).map(r=>r.to);for(const r of this.#l)r(t,o,e);return o}predictNextDetailed(t,e){const s=e.count??U,i=this.#e.getWeights(t,e.actor),o=this.#e.isWarmupComplete(),r=this.#e.getTransitionCount();return{predictions:i.slice(0,s).map(l=>{const a=l.weight>0?Math.min(1,l.predictiveWeight/l.weight):0,u={frequency:Math.min(1,l.predictiveWeight/pt),recency:.5,engagement:.5,sampleSize:Math.min(1,r/mt)};return{nodeId:l.to,score:l.weight,baseWeight:l.baseWeight,predictiveWeight:l.predictiveWeight,confidence:a,factors:u}}),currentNode:t,context:e,computedAt:v(),warmupComplete:o,transitionCount:r}}isValidTransition(t,e){return this.#t.hasTransition(t,e)}getValidTransitions(t){return this.#t.getTransitions(t)}startSession(t,e){const s=e??L(),i=v(),o=this.#i.get(t);o&&this.#s.get(o)?.active&&this.endSession(o,"abandoned");const r={id:s,actor:t,startTime:i,lastActivity:i,nodeHistory:[]},c={info:r,events:[{id:L(),sessionId:s,actor:t,from:"",to:"",timestamp:i,sessionElapsed:0,eventType:"session_start"}],active:!0};this.#s.set(s,c),this.#i.set(t,s);for(const l of this.#h)l(r);return r}getSession(t){return this.#s.get(t)?.info}getActiveSession(t){const e=this.#i.get(t);if(!e)return;const s=this.#s.get(e);if(!s?.active)return;if(v()-s.info.lastActivity>this.#d){this.endSession(e,"timeout");return}return s.info}hasSession(t){return this.#s.has(t)}endSession(t,e){const s=this.#s.get(t);if(!s)throw new p("SESSION_NOT_FOUND",`Session not found: ${t}`,{sessionId:t});if(!s.active)throw new p("SESSION_ALREADY_ENDED",`Session already ended: ${t}`,{sessionId:t});const i=v();s.events.push({id:L(),sessionId:t,actor:s.info.actor,from:"",to:"",timestamp:i,sessionElapsed:i-s.info.startTime,eventType:"session_end",metadata:{reason:e}}),s.active=!1,this.#i.get(s.info.actor)===t&&this.#i.delete(s.info.actor);for(const o of this.#u)o(s.info,e)}resumeSession(t,e){const s=this.#s.get(t);if(!s)throw new p("SESSION_NOT_FOUND",`Session not found: ${t}`,{sessionId:t});const i=v();s.active=!0,s.info=Object.assign({},s.info,{lastActivity:i},e.path!==void 0?{path:e.path}:{}),this.#i.set(e.actor,t)}getSessionChain(t,e){const s=e?.limit??100,i=[],o=new Set;let r=0;for(const[l,a]of this.#s){if(a.info.actor!==t)continue;if(e?.startTime||e?.endTime){const h=a.info.startTime,f=a.events[a.events.length-1]?.timestamp??h;if(e.startTime&&f<e.startTime||e.endTime&&h>e.endTime)continue}o.add(l);for(const h of a.events)h.eventType==="transition"&&i.push(h);const u=a.events[a.events.length-1];u&&(r+=u.sessionElapsed)}return i.sort((l,a)=>l.timestamp-a.timestamp),{events:i.slice(-s),sessionIds:Array.from(o),totalDuration:r}}truncateChain(t,e){const s=this.#s.get(t);if(!s)throw new p("SESSION_NOT_FOUND",`Session not found: ${t}`,{sessionId:t});const i=e??"recency",o=et;if(!(s.events.length<=o))switch(i){case"recency":s.events.splice(0,s.events.length-o);break;case"frequency":s.events.splice(0,s.events.length-o);break;case"hybrid":s.events.splice(0,s.events.length-o);break}}onTransition(t){return this.#c.add(t),()=>{this.#c.delete(t)}}onPrediction(t){return this.#l.add(t),()=>{this.#l.delete(t)}}onSessionStart(t){return this.#h.add(t),()=>{this.#h.delete(t)}}onSessionEnd(t){return this.#u.add(t),()=>{this.#u.delete(t)}}onError(t){return this.#f.add(t),()=>{this.#f.delete(t)}}getProceduralGraph(){return this.#t}getPredictiveGraph(){return this.#e}getActivityTracker(){return this.#a}async getEvents(t){return this.#r?this.#r.load(t):[]}async getEventCount(t){return this.#r?this.#r.getCount(t):0}destroy(){this.#c.clear(),this.#l.clear(),this.#h.clear(),this.#u.clear(),this.#f.clear(),this.#s.clear(),this.#i.clear()}}class Tt{#t;#e;#s;#i;#o;#n;#d;#a;#r;#c;constructor(t={}){this.#t=new Map,this.#e=new Map,this.#s=new Map,this.#i=t.validateOnChange??!1,this.#o=t.allowDuplicateNodes??!1,this.#n=new Set,this.#d=new Set,this.#a=new Set,this.#r=new Set,this.#c=new Set,t.onNodeAdded&&this.#n.add(t.onNodeAdded),t.onNodeRemoved&&this.#d.add(t.onNodeRemoved),t.onTransitionAdded&&this.#a.add(t.onTransitionAdded),t.onTransitionRemoved&&this.#r.add(t.onTransitionRemoved),t.onValidation&&this.#c.add(t.onValidation)}#l(){if(this.#i){const t=this.validate();for(const e of this.#c)e([...t.errors,...t.warnings])}}addNode(t){if(!this.#o&&this.#t.has(t.id))throw new p("DUPLICATE_NODE",`Node already exists: ${t.id}`,{nodeId:t.id});const e=y(Object.assign({id:t.id},t.label!==void 0?{label:t.label}:{},t.type!==void 0?{type:t.type}:{},t.metadata!==void 0?{metadata:t.metadata}:{}));this.#t.set(e.id,e);for(const s of this.#n)s(e);return this.#l(),this}addNodes(t){for(const e of t)this.addNode(e);return this}removeNode(t){if(!this.#t.has(t))throw new p("NODE_NOT_FOUND",`Node not found: ${t}`,{nodeId:t});const e=[];for(const[s,i]of this.#e)(i.from===t||i.to===t)&&e.push(s);for(const s of e){const i=this.#e.get(s);if(this.#e.delete(s),i)for(const o of this.#r)o(i.from,i.to)}this.#t.delete(t);for(const s of this.#d)s(t);return this.#l(),this}updateNode(t,e){const s=this.#t.get(t);if(!s)throw new p("NODE_NOT_FOUND",`Node not found: ${t}`,{nodeId:t});const i=e.label??s.label,o=e.type??s.type,r=e.metadata??s.metadata,c=y(Object.assign({id:s.id},i!==void 0?{label:i}:{},o!==void 0?{type:o}:{},r!==void 0?{metadata:r}:{}));return this.#t.set(t,c),this.#l(),this}addTransition(t){const e=b(t.from,t.to);if(this.#e.has(e))throw new p("DUPLICATE_TRANSITION",`Transition already exists: ${t.from} -> ${t.to}`,{transitionKey:e});this.#t.has(t.from)||this.addNode({id:t.from}),this.#t.has(t.to)||this.addNode({id:t.to});const s=y(Object.assign({from:t.from,to:t.to,weight:t.weight,actor:t.actor},t.metadata!==void 0?{metadata:t.metadata}:{}));this.#e.set(e,s);for(const i of this.#a)i(s);return this.#l(),this}addTransitions(t){for(const e of t)this.addTransition(e);return this}removeTransition(t,e){const s=b(t,e);if(!this.#e.has(s))throw new p("INVALID_TRANSITION",`Transition not found: ${t} -> ${e}`,{transitionKey:s});this.#e.delete(s);for(const i of this.#r)i(t,e);return this.#l(),this}updateTransition(t,e,s){const i=b(t,e),o=this.#e.get(i);if(!o)throw new p("INVALID_TRANSITION",`Transition not found: ${t} -> ${e}`,{transitionKey:i});const r=s.metadata??o.metadata,c=y(Object.assign({from:o.from,to:o.to,weight:s.weight??o.weight,actor:s.actor??o.actor},r!==void 0?{metadata:r}:{}));return this.#e.set(i,c),this.#l(),this}addProcedure(t){if(this.#s.has(t.id))throw new p("INVALID_PROCEDURE",`Procedure already exists: ${t.id}`);const e=y(Object.assign({id:t.id,actions:t.actions},t.metadata!==void 0?{metadata:t.metadata}:{}));return this.#s.set(e.id,e),this.#l(),this}removeProcedure(t){if(!this.#s.has(t))throw new p("INVALID_PROCEDURE",`Procedure not found: ${t}`);return this.#s.delete(t),this.#l(),this}updateProcedure(t,e){const s=this.#s.get(t);if(!s)throw new p("INVALID_PROCEDURE",`Procedure not found: ${t}`);const i=e.metadata??s.metadata,o=y(Object.assign({id:s.id,actions:e.actions??s.actions},i!==void 0?{metadata:i}:{}));return this.#s.set(t,o),this.#l(),this}getNodes(){return Array.from(this.#t.values())}getTransitions(){return Array.from(this.#e.values())}getProcedures(){return Array.from(this.#s.values())}hasNode(t){return this.#t.has(t)}hasTransition(t,e){const s=b(t,e);return this.#e.has(s)}validate(){const t=[],e=[];this.#t.size===0&&t.push({passed:!1,message:"Graph has no nodes",severity:"error",suggestion:"Add at least one node"}),this.#e.size===0&&this.#t.size>1&&t.push({passed:!1,message:"Graph has no transitions",severity:"error",suggestion:"Add transitions to connect nodes"});const s=new Set;for(const i of this.#e.values())s.add(i.from),s.add(i.to);for(const i of this.#t.keys())!s.has(i)&&this.#t.size>1&&e.push({passed:!1,message:`Node '${i}' is isolated`,severity:"warning",suggestion:"Connect this node or remove it",nodeId:i});for(const i of this.#s.values())for(const o of i.actions)this.#t.has(o)||t.push({passed:!1,message:`Procedure '${i.id}' references unknown node '${o}'`,severity:"error",suggestion:`Add node '${o}' or remove from procedure`});return{valid:t.length===0,errors:t,warnings:e}}isValid(){return this.validate().valid}build(){const t=this.validate();if(!t.valid)throw new p("BUILD_FAILED",`Cannot build invalid graph: ${t.errors[0]?.message??"Unknown error"}`);return new q({nodes:this.getNodes(),transitions:this.getTransitions(),procedures:this.getProcedures(),validateOnCreate:!1})}clear(){return this.#t.clear(),this.#e.clear(),this.#s.clear(),this}onNodeAdded(t){return this.#n.add(t),()=>{this.#n.delete(t)}}onNodeRemoved(t){return this.#d.add(t),()=>{this.#d.delete(t)}}onTransitionAdded(t){return this.#a.add(t),()=>{this.#a.delete(t)}}onTransitionRemoved(t){return this.#r.add(t),()=>{this.#r.delete(t)}}onValidation(t){return this.#c.add(t),()=>{this.#c.delete(t)}}toJSON(){const t={nodes:this.getNodes(),transitions:this.getTransitions(),procedures:this.getProcedures()};return JSON.stringify(t,null,2)}toYAML(){const t=[];t.push("nodes:");for(const e of this.#t.values())t.push(`  - id: "${e.id}"`),e.label&&t.push(`    label: "${e.label}"`),e.type&&t.push(`    type: "${e.type}"`);t.push(""),t.push("transitions:");for(const e of this.#e.values())t.push(`  - from: "${e.from}"`),t.push(`    to: "${e.to}"`),t.push(`    weight: ${e.weight}`),t.push(`    actor: "${e.actor}"`);if(this.#s.size>0){t.push(""),t.push("procedures:");for(const e of this.#s.values()){t.push(`  - id: "${e.id}"`),t.push("    actions: ");for(const s of e.actions)t.push(`      - "${s}"`)}}return t.join(`
`)}fromJSON(t){let e;try{e=JSON.parse(t)}catch(s){const i=s instanceof Error?{cause:s}:void 0;throw new p("IMPORT_FAILED","Failed to parse JSON",i)}return this.fromDefinition(e)}fromYAML(t){try{const e=[],s=[],i=[];let o=null,r=null,c=[];const l=t.split(`
`);for(const a of l){const u=a.trim();if(!(u===""||u.startsWith("#"))){if(u==="nodes:"){o="nodes";continue}if(u==="transitions:"){o="transitions";continue}if(u==="procedures:"){o="procedures";continue}if(u.startsWith("- ")){r&&o&&(o==="nodes"?this.#h(e,r):o==="transitions"?this.#u(s,r):o==="procedures"&&(this.#f(i,r,c),c=[]));const h=u.slice(2);if(h.includes(":")){const f=h.indexOf(":"),m=h.slice(0,f).trim(),g=h.slice(f+1).trim();r={},r[m]=R(g)}else c.push(R(h))}else if(u.includes(":")&&r){const h=u.indexOf(":"),f=u.slice(0,h).trim(),m=u.slice(h+1).trim();f==="actions"||(r[f]=R(m))}}}return r&&o&&(o==="nodes"?this.#h(e,r):o==="transitions"?this.#u(s,r):o==="procedures"&&this.#f(i,r,c)),this.fromDefinition({nodes:e,transitions:s,procedures:i})}catch(e){if(e instanceof p)throw e;const s=e instanceof Error?{cause:e}:void 0;throw new p("IMPORT_FAILED","Failed to parse YAML",s)}}#h(t,e){const s=e.id;if(typeof s!="string")return;const i=Object.assign({id:s},typeof e.label=="string"?{label:e.label}:{},typeof e.type=="string"?{type:e.type}:{});t.push(i)}#u(t,e){const s=e.from,i=e.to,o=e.weight,r=e.actor;typeof s!="string"||typeof i!="string"||typeof o!="number"||typeof r!="string"||t.push({from:s,to:i,weight:o,actor:r})}#f(t,e,s){const i=e.id;typeof i=="string"&&t.push({id:i,actions:s})}fromDefinition(t){if(this.clear(),t.nodes)for(const e of t.nodes)this.addNode(e);for(const e of t.transitions)this.addTransition(e);if(t.procedures)for(const e of t.procedures)this.addProcedure(e);return this}destroy(){this.#n.clear(),this.#d.clear(),this.#a.clear(),this.#r.clear(),this.#c.clear(),this.clear()}}class St{#t;#e;#s;#i;#o;#n;constructor(t,e={}){this.#t=t,this.#e=e.strictMode??!1,this.#s=e.validateGuards??!0,this.#i=e.customRules??[],this.#o=[],this.#n=new Set,e.onValidationComplete&&this.#n.add(e.onValidationComplete)}runStaticChecks(){this.#o.length=0;const e=this.checkCycles().length>0,s=this.findDanglingNodes();for(const l of s)this.#o.push({passed:!this.#e,message:`Node '${l}' has no outgoing transitions (terminal node)`,severity:this.#e?"error":"info",suggestion:"This node is a terminal/exit point in the workflow",nodeId:l});const i=this.findUnreachableNodes();for(const l of i)this.#o.push({passed:!1,message:`Node '${l}' is unreachable from any start node`,severity:"error",suggestion:"Add incoming transitions or remove this node",nodeId:l});if(this.findMissingBoundaryNodes().missingStart&&(e?this.#o.push({passed:!0,message:"Graph is cyclical - no explicit start node required",severity:"info",suggestion:"Cyclical workflows allow entry from any node in the cycle"}):this.#o.push({passed:!1,message:"Graph has no start nodes (all nodes have incoming transitions)",severity:this.#e?"error":"warning",suggestion:"Ensure at least one node has no incoming transitions"})),this.#s){const l=this.validateGuards();for(const a of l)a.valid||this.#o.push({passed:!1,message:`Invalid guard expression: ${a.error}`,severity:"error",suggestion:"Fix the guard syntax",transitionKey:a.transitionKey})}const r=this.validateProcedures();this.#o.push(...r);const c=this.checkConnectivity();c.passed||this.#o.push(c);for(const l of this.#i){const a=l.validate(this.#t);this.#o.push(a)}for(const l of this.#n)l(this.#o);return this.#o}findDanglingNodes(){const t=[],e=this.#t.getNodes();for(const s of e){const i=this.#t.getTransitions(s.id),o=this.#t.getTransitionsTo(s.id);i.length===0&&o.length>0&&t.push(s.id)}return t}findUnreachableNodes(){const t=this.#t.getStartNodes();if(t.length===0)return[];const e=new Set(t),s=[...t];for(;s.length>0;){const r=s.shift();if(!r)continue;const c=this.#t.getTransitions(r);for(const l of c)e.has(l.to)||(e.add(l.to),s.push(l.to))}const i=[],o=this.#t.getNodes();for(const r of o)e.has(r.id)||i.push(r.id);return i}findMissingBoundaryNodes(){const t=this.#t.getStartNodes(),e=this.#t.getEndNodes();return{hasStartNodes:t.length>0,hasEndNodes:e.length>0,startNodes:t,endNodes:e,missingStart:t.length===0&&this.#t.getNodes().length>0,missingEnd:e.length===0&&this.#t.getNodes().length>0}}validateGuards(){const t=[],e=this.#t.getAllTransitions();for(const s of e){const i=s.metadata?.guard;if(!i)continue;const o=b(s.from,s.to);vt(i)?t.push({transitionKey:o,guard:i,valid:!0}):t.push({transitionKey:o,guard:i,valid:!1,error:"Invalid guard expression syntax"})}return t}validateProcedures(){const t=[],e=this.#t.getProcedures();for(const s of e){for(const i of s.actions)this.#t.hasNode(i)||t.push({passed:!1,message:`Procedure '${s.id}' references unknown node '${i}'`,severity:"error",suggestion:`Add node '${i}' or remove from procedure`});for(let i=0;i<s.actions.length-1;i++){const o=s.actions[i],r=s.actions[i+1];o&&r&&!this.#t.hasTransition(o,r)&&t.push({passed:!1,message:`Procedure '${s.id}' has disconnected actions: '${o}' -> '${r}'`,severity:"warning",suggestion:`Add transition from '${o}' to '${r}'`})}}return t}checkConnectivity(){const t=this.#t.getNodes();if(t.length===0)return{passed:!0,message:"Empty graph is trivially connected",severity:"info"};const e=new Set,s=new Map;for(const a of t)s.set(a.id,new Set);const i=this.#t.getAllTransitions();for(const a of i)s.get(a.from)?.add(a.to),s.get(a.to)?.add(a.from);const o=t[0];if(!o)return{passed:!0,message:"Empty graph is trivially connected",severity:"info"};const r=o.id,c=[r];for(e.add(r);c.length>0;){const a=c.shift();if(!a)continue;const u=s.get(a)??new Set;for(const h of u)e.has(h)||(e.add(h),c.push(h))}const l=e.size===t.length;return{passed:l,message:l?"Graph is fully connected":`Graph is disconnected:  ${t.length-e.size} node(s) unreachable`,severity:l?"info":"error"}}checkCycles(){const t=[],e=this.#t.getNodes(),s=new Set,i=new Set,o=[],r=c=>{s.add(c),i.add(c),o.push(c);const l=this.#t.getTransitions(c);for(const a of l)if(!s.has(a.to))r(a.to);else if(i.has(a.to)){const u=o.indexOf(a.to),h=[...o.slice(u),a.to];t.push(h)}o.pop(),i.delete(c)};for(const c of e)s.has(c.id)||r(c.id);return t}isValid(){return this.#o.length===0&&this.runStaticChecks(),this.getErrorCount()===0}getErrorCount(){return this.#o.filter(t=>t.severity==="error").length}getWarningCount(){return this.#o.filter(t=>t.severity==="warning").length}getResults(){return this.#o.length===0&&this.runStaticChecks(),this.#o}onValidationComplete(t){return this.#n.add(t),()=>{this.#n.delete(t)}}destroy(){this.#n.clear(),this.#o.length=0}}class bt{#t;#e;#s;#i;constructor(t,e,s={}){this.#t=t,this.#e=e,this.#s=new Set,this.#i=new Set,s.onAnalysisComplete&&this.#s.add(s.onAnalysisComplete),s.onPatternDetected&&this.#i.add(s.onPatternDetected)}#o(t,e){for(const s of this.#s)s(t,e)}#n(t){for(const e of this.#i)e(t)}findHotLoops(t){const e=t?.threshold??at,s=this.findStronglyConnectedComponents(),i=[];for(const o of s){if(o.nodes.length<2)continue;let r=0,c=0;for(const a of o.nodes){const u=this.#e.getWeights(a,"user");for(const h of u)o.nodes.includes(h.to)&&(r+=h.predictiveWeight,c++)}const l=c>0?r/c:0;l>=e&&i.push({nodes:o.nodes,frequency:l,avgDuration:0,loopType:"hot",exitTransitions:o.exitPoints})}return this.#o("hotLoops",i),i}findInfiniteLoops(t){t?.maxLength;const e=this.findStronglyConnectedComponents(),s=[];for(const i of e)i.exitPoints.length===0&&i.nodes.length>0&&s.push({nodes:i.nodes,frequency:0,avgDuration:0,loopType:"infinite",exitTransitions:[]});return this.#o("infiniteLoops",s),s}findUnproductiveLoops(){const t=this.findStronglyConnectedComponents(),e=[];for(const s of t){if(s.nodes.length<2)continue;let i=0,o=0;for(const r of s.nodes){const c=this.#e.getWeights(r,"user");for(const l of c)s.nodes.includes(l.to)?i+=l.predictiveWeight:o+=l.predictiveWeight}i>o*3&&e.push({nodes:s.nodes,frequency:i,avgDuration:0,loopType:"unproductive",exitTransitions:s.exitPoints})}return this.#o("unproductiveLoops",e),e}findHierarchicalLoops(){const t=this.findStronglyConnectedComponents(),e=[];for(const s of t)for(const i of t){if(s===i||i.nodes.length>=s.nodes.length)continue;i.nodes.every(r=>s.nodes.includes(r))&&e.push({nodes:i.nodes,frequency:0,avgDuration:0,loopType:"hierarchical",exitTransitions:i.exitPoints})}return this.#o("hierarchicalLoops",e),e}findAutomatableLoops(){const t=this.findStronglyConnectedComponents(),e=[];for(const s of t){if(s.nodes.length<2)continue;let i=0,o=0;for(const r of s.nodes){const c=this.#e.getWeights(r,"system"),l=this.#e.getWeights(r,"user");for(const a of c)s.nodes.includes(a.to)&&(i+=a.predictiveWeight);for(const a of l)s.nodes.includes(a.to)&&(o+=a.predictiveWeight)}(i>0||o>10)&&e.push({nodes:s.nodes,frequency:Math.max(i,o),avgDuration:0,loopType:"automatable",exitTransitions:s.exitPoints})}return this.#o("automatableLoops",e),e}findStronglyConnectedComponents(){const t=this.#t.getNodes(),e=[];let s=0;const i=new Map,o=new Map,r=new Set,c=[],l=a=>{i.set(a,s),o.set(a,s),s++,c.push(a),r.add(a);const u=this.#t.getTransitions(a);for(const h of u)i.has(h.to)?r.has(h.to)&&o.set(a,Math.min(o.get(a),i.get(h.to))):(l(h.to),o.set(a,Math.min(o.get(a),o.get(h.to))));if(o.get(a)===i.get(a)){const h=[];let f;do f=c.pop(),f&&(r.delete(f),h.push(f));while(f!==a);if(h.length>0){const m=[],g=[];for(const $ of h){const X=this.#t.getTransitionsTo($),Q=this.#t.getTransitions($);for(const D of X)if(!h.includes(D.from)){m.push($);break}for(const D of Q)h.includes(D.to)||g.push(D.to)}e.push({id:`scc-${e.length}`,nodes:h,entryPoints:[...new Set(m)],exitPoints:[...new Set(g)]})}}};for(const a of t)i.has(a.id)||l(a.id);return e}findSCCKosaraju(){const t=this.#t.getNodes(),e=new Set,s=[],i=a=>{e.add(a);const u=this.#t.getTransitions(a);for(const h of u)e.has(h.to)||i(h.to);s.push(a)};for(const a of t)e.has(a.id)||i(a.id);const o=new Map;for(const a of t)o.set(a.id,[]);const r=this.#t.getAllTransitions();for(const a of r)o.get(a.to)?.push(a.from);e.clear();const c=[],l=(a,u)=>{e.add(a),u.push(a);const h=o.get(a)??[];for(const f of h)e.has(f)||l(f,u)};for(;s.length>0;){const a=s.pop();if(!e.has(a)){const u=[];l(a,u),u.length>0&&c.push({id:`scc-${c.length}`,nodes:u,entryPoints:[],exitPoints:[]})}}return c}classifyEdges(){const t=this.#t.getNodes(),e=[],s=new Map,i=new Map;let o=0;const r=(c,l)=>{s.set(c,o++);const a=this.#t.getTransitions(c);for(const u of a){let h;s.has(u.to)?i.has(u.to)?s.get(c)<s.get(u.to)?(h="forward",e.push({from:u.from,to:u.to,classification:h})):(h="cross",e.push({from:u.from,to:u.to,classification:h})):(h="back",e.push({from:u.from,to:u.to,classification:h})):(h="tree",e.push({from:u.from,to:u.to,classification:h}),r(u.to))}i.set(c,o++)};for(const c of t)s.has(c.id)||r(c.id);return e}findBottlenecks(t){const e=t?.trafficThreshold??nt;t?.delayThreshold;const s=[],i=this.#t.getNodes();for(const o of i){const r=this.#t.getTransitionsTo(o.id),c=this.#t.getTransitions(o.id);let l=0,a=0;for(const h of r){const m=this.#e.getWeights(h.from,"user").find(g=>g.to===o.id);m&&(l+=m.predictiveWeight)}for(const h of c){const m=this.#e.getWeights(o.id,"user").find(g=>g.to===h.to);m&&(a+=m.predictiveWeight)}const u=a>0?l/a:l;l>=e&&u>2&&s.push({nodeId:o.id,incomingTraffic:l,outgoingTraffic:a,avgDelay:0,maxDelay:0,congestionScore:u})}return this.#o("bottlenecks",s),s}findAutomationOpportunities(t){const e=t?.minRepetitions??ot,s=t?.minSequenceLength??it,i=t?.maxSequenceLength??st,o=[],r=this.findStronglyConnectedComponents();for(const c of r){if(c.nodes.length<s||c.nodes.length>i)continue;let l=0;for(const u of c.nodes){const h=this.#e.getWeights(u,"user");for(const f of h)l+=f.predictiveWeight}const a=l/c.nodes.length;if(a>=e){let u="robotic";a>20?u="scheduled":a>10&&(u="triggered");const h=Math.min(a/20,1);o.push({sequence:c.nodes,frequency:a,avgDuration:0,automationType:u,suggestion:`Automate sequence:  ${c.nodes.join(" -> ")}`,confidence:h}),this.#n({sequence:c.nodes,frequency:a,avgDuration:0,actors:["user"]})}}return this.#o("automationOpportunities",o),o}analyzeByContext(t){const e=[];for(const s of t.groupBy)if(s==="procedure"){const i=this.#t.getProcedures();for(const o of i){const r=[];let c=0;for(let l=0;l<o.actions.length-1;l++){const a=o.actions[l],u=o.actions[l+1];if(a&&u){const f=this.#e.getWeights(a,"user").find(m=>m.to===u);f&&(c+=f.predictiveWeight)}}r.push({sequence:o.actions,frequency:c,avgDuration:0,actors:["user"]}),e.push({groupKey:"procedure",groupValue:o.id,patterns:r,recommendations:c>10?["High usage - consider optimization"]:[]})}}return this.#o("contextAnalysis",e),e}compareContexts(t,e){return[]}getSummary(){const t=this.findHotLoops(),e=this.findBottlenecks(),s=this.findAutomationOpportunities(),i=this.findStronglyConnectedComponents(),o=this.#t.getNodes();let r=0,c=0;for(const u of o){const h=this.#t.getTransitions(u.id);r+=h.length,c++}const l=c>0?r/c:0,a=[];for(const u of i.slice(0,5)){let h=0;for(const f of u.nodes){const m=this.#e.getWeights(f,"user");for(const g of m)h+=g.predictiveWeight}a.push({sequence:u.nodes,frequency:h/u.nodes.length,avgDuration:0,actors:["user"]})}return a.sort((u,h)=>h.frequency-u.frequency),{loopCount:t.length,bottleneckCount:e.length,automationOpportunityCount:s.length,sccCount:i.length,avgPathLength:l,mostFrequentPaths:a.slice(0,5)}}onAnalysisComplete(t){return this.#s.add(t),()=>{this.#s.delete(t)}}onPatternDetected(t){return this.#i.add(t),()=>{this.#i.delete(t)}}destroy(){this.#s.clear(),this.#i.clear()}}class Nt{#t;#e;#s;#i;#o=0;#n=0;#d=0;#a=0;#r="unknown";#c=[];#l=new Set;#h=new Set;#u;#f;#g;#p;constructor(t){this.#t=t?.idleThreshold??ct,this.#e=t?.awayThreshold??dt,this.#s=t?.trackVisibility??!0,this.#g=this.#y.bind(this),this.#p=this.#N.bind(this),t?.onEngagementChange&&this.#l.add(t.onEngagementChange),t?.onDwellComplete&&this.#h.add(t.onDwellComplete),typeof window<"u"&&this.#S()}onEngagementChange(t){return this.#l.add(t),()=>this.#l.delete(t)}onDwellComplete(t){return this.#h.add(t),()=>this.#h.delete(t)}enterNode(t){this.#i&&this.exitNode();const e=v();this.#i=t,this.#o=e,this.#n=0,this.#d=0,this.#a=e,this.#m("active"),this.#T()}exitNode(){if(!this.#i)return;const t=v(),e=t-this.#a;this.#r==="active"?this.#n+=e:this.#d+=e;const s={nodeId:this.#i,enterTime:this.#o,exitTime:t,activeTime:this.#n,idleTime:this.#d,engagement:this.#E(),engagementScore:this.#C()};return this.#c.push(s),this.#L(s),this.#i=void 0,this.#v(),s}getEngagementState(){return this.#r}getCurrentNodeId(){return this.#i}getCurrentDwell(){if(!this.#i)return;const e=v()-this.#a;let s=this.#n,i=this.#d;return this.#r==="active"?s+=e:i+=e,{nodeId:this.#i,enterTime:this.#o,activeTime:s,idleTime:i,engagement:this.#r}}getDwellHistory(){return[...this.#c]}getTotalActiveTime(){return this.#c.reduce((t,e)=>t+e.activeTime,0)}getTotalIdleTime(){return this.#c.reduce((t,e)=>t+e.idleTime,0)}clearHistory(){this.#c=[]}destroy(){this.#i&&this.exitNode(),this.#v(),this.#f&&clearInterval(this.#f),typeof window<"u"&&this.#b(),this.#l.clear(),this.#h.clear()}#S(){window.addEventListener("pointermove",this.#g,{passive:!0}),window.addEventListener("pointerdown",this.#g,{passive:!0}),window.addEventListener("keydown",this.#g,{passive:!0}),window.addEventListener("scroll",this.#g,{passive:!0}),this.#s&&document.addEventListener("visibilitychange",this.#p)}#b(){window.removeEventListener("pointermove",this.#g),window.removeEventListener("pointerdown",this.#g),window.removeEventListener("keydown",this.#g),window.removeEventListener("scroll",this.#g),this.#s&&document.removeEventListener("visibilitychange",this.#p)}#y(){if(!this.#i)return;const t=v(),e=t-this.#a;this.#r==="active"?this.#n+=e:this.#d+=e,this.#a=t,this.#r!=="active"&&this.#m("active"),this.#T()}#N(){this.#i&&typeof document<"u"&&(document.visibilityState==="hidden"?this.#w():this.#y())}#$(){if(!this.#i)return;const t=v(),e=t-this.#a;this.#r==="active"&&(this.#n+=e),this.#a=t,this.#m("idle"),this.#u=setTimeout(()=>{this.#w()},this.#e-this.#t)}#w(){if(!this.#i)return;const t=v(),e=t-this.#a;this.#r==="idle"?this.#d+=e:this.#r==="active"&&(this.#n+=e),this.#a=t,this.#m("away"),this.#v()}#m(t){t!==this.#r&&this.#i&&(this.#r=t,this.#A(t,this.#i))}#T(){this.#v(),this.#u=setTimeout(()=>{this.#$()},this.#t)}#v(){this.#u&&(clearTimeout(this.#u),this.#u=void 0)}#E(){const t=this.#n+this.#d;if(t===0)return"unknown";const e=this.#n/t;return e>=.7?"active":e>=.3?"idle":"away"}#C(){const t=this.#n+this.#d;if(t===0)return 0;const e=this.#n/t,s=Math.min(1,Math.log10(t/1e3+1)/2);return Math.round((e*H.active+(1-e)*H.idle)*s*100)/100}#A(t,e){for(const s of this.#l)s(t,e)}#L(t){for(const e of this.#h)e(t)}}class $t{#t;#e;#s;#i;constructor(t){this.#t=t?.maxRecentEvents??lt,this.#e=t?.includePatterns??!1,this.#s=t?.includeDwell??!0,this.#i=t?.getNodeLabel??(e=>e)}format(t,e,s){const i=s?.maxRecentEvents??this.#t,o=s?.includePatterns??this.#e,r=s?.includeDwell??this.#s,c=s?.getNodeLabel??this.#i,l=e.slice(-i),a=t.predictions.slice(0,ht).map(g=>({nodeId:g.nodeId,label:c(g.nodeId),confidencePercent:Math.round(g.confidence*100),reasoning:Et(g.factors)})),u=l.map(g=>{const $={from:g.from,to:g.to,actor:g.actor,timestamp:g.timestamp};return r&&g.dwell?.activeTime&&($.dwellSeconds=Math.round(g.dwell.activeTime/1e3)),g.engagement&&($.engagement=g.engagement),$}),f=l[l.length-1]?.engagement??"unknown",m={currentNode:t.currentNode,predictions:a,warmupComplete:t.warmupComplete,transitionCount:t.transitionCount,recentActivity:u,engagement:f};return o&&(m.patterns=Ct(e)),m}toNaturalLanguage(t){const e=[];if(e.push(`Current location: ${t.currentNode}`),e.push(`User engagement: ${t.engagement}`),t.warmupComplete&&t.predictions.length>0){e.push(""),e.push("Predicted next actions (based on learned patterns):");for(const s of t.predictions.slice(0,3))e.push(`  - ${s.label}: ${s.confidencePercent}% likely (${s.reasoning})`)}else t.warmupComplete||(e.push(""),e.push("Note: Predictions will improve with more usage data."));if(t.recentActivity.length>0){e.push(""),e.push("Recent activity:");for(const s of t.recentActivity.slice(-5)){const i=s.dwellSeconds?` (${s.dwellSeconds}s dwell)`:"";e.push(`  - ${s.from} â†’ ${s.to}${i}`)}}return t.patterns&&(e.push(""),e.push("Pattern insights:"),t.patterns.frequentPaths.length>0&&e.push(`  - Frequent paths: ${t.patterns.frequentPaths.join(", ")}`),t.patterns.bottlenecks.length>0&&e.push(`  - Bottlenecks: ${t.patterns.bottlenecks.join(", ")}`),t.patterns.automationCandidates.length>0&&e.push(`  - Automation candidates: ${t.patterns.automationCandidates.join(", ")}`),t.patterns.avgSessionMinutes>0&&e.push(`  - Avg session duration: ${t.patterns.avgSessionMinutes} minutes`)),e.join(`
`)}toJSON(t){return JSON.stringify(t,null,2)}}function Et(n){const t=[];return n.frequency>.7&&t.push("frequently visited"),n.recency>.7&&t.push("recently accessed"),n.engagement>.7&&t.push("high engagement"),n.sampleSize>.7&&t.push("strong pattern"),t.length>0?t.join(", "):"based on workflow structure"}function Ct(n){if(n.length===0)return{frequentPaths:[],bottlenecks:[],automationCandidates:[],avgSessionMinutes:0};const t=new Map,e=new Map,s=new Map;for(const h of n){const f=`${h.from}â†’${h.to}`;if(t.set(f,(t.get(f)??0)+1),h.dwell){const g=e.get(h.from)??[];g.push(h.dwell.activeTime+h.dwell.idleTime),e.set(h.from,g)}const m=s.get(h.sessionId);m?m.end=h.timestamp:s.set(h.sessionId,{start:h.timestamp,end:h.timestamp})}const o=[...t.entries()].sort((h,f)=>f[1]-h[1]).slice(0,3).map(([h])=>h),r=[];for(const[h,f]of e)f.reduce((g,$)=>g+$,0)/f.length>ut&&r.push(h);const c=[],l=At(n);for(const[h,f]of l)f>=3&&c.push(h);let a=0;for(const h of s.values())a+=h.end-h.start;const u=s.size>0?Math.round(a/s.size/6e4):0;return{frequentPaths:o.slice(0,5),bottlenecks:r.slice(0,5),automationCandidates:c.slice(0,5),avgSessionMinutes:u}}function At(n){const t=new Map;for(let e=2;e<=3;e++)for(let s=0;s<=n.length-e;s++){const i=n.slice(s,s+e).map(o=>o.to).join("â†’");t.set(i,(t.get(i)??0)+1)}return t}function V(n){return new q(n)}function B(n,t){return new yt(n,t)}function j(n,t,e){return new wt(n,t,e)}function Lt(n){return new Tt(n)}function z(n,t){return new St(n,t)}function G(n,t,e){return new bt(n,t,e)}function It(n){return new Nt(n)}function Dt(n){return new $t(n)}const P=[{id:"ecommerce",name:"E-Commerce Checkout",icon:"ðŸ›’",description:"Cyclical checkout flow - users can browse, buy, and return for more",startNode:"browse",nodes:[{id:"browse",label:"Browse Products",icon:"ðŸ›ï¸"},{id:"product",label:"Product Details",icon:"ðŸ“¦"},{id:"cart",label:"Shopping Cart",icon:"ðŸ›’"},{id:"shipping",label:"Shipping Info",icon:"ðŸšš"},{id:"payment",label:"Payment",icon:"ðŸ’³"},{id:"review",label:"Order Review",icon:"ðŸ“‹"},{id:"confirm",label:"Confirmation",icon:"âœ…"}],transitions:[{from:"browse",to:"product",weight:2,actor:"user"},{from:"browse",to:"cart",weight:1,actor:"user"},{from:"product",to:"browse",weight:1,actor:"user"},{from:"product",to:"cart",weight:2,actor:"user"},{from:"cart",to:"browse",weight:1,actor:"user"},{from:"cart",to:"shipping",weight:2,actor:"user"},{from:"shipping",to:"cart",weight:1,actor:"user"},{from:"shipping",to:"payment",weight:2,actor:"user"},{from:"payment",to:"shipping",weight:1,actor:"user"},{from:"payment",to:"review",weight:2,actor:"user"},{from:"review",to:"payment",weight:1,actor:"user"},{from:"review",to:"confirm",weight:3,actor:"user"},{from:"confirm",to:"browse",weight:2,actor:"user"}],preloadRecords:[{from:"browse",to:"product",actor:"user",count:200},{from:"product",to:"cart",actor:"user",count:80},{from:"cart",to:"shipping",actor:"user",count:60},{from:"shipping",to:"payment",actor:"user",count:55},{from:"payment",to:"review",actor:"user",count:50},{from:"review",to:"confirm",actor:"user",count:48},{from:"confirm",to:"browse",actor:"user",count:30}]},{id:"saas",name:"SaaS Dashboard",icon:"ðŸ“Š",description:"Cyclical navigation through account management features",startNode:"dashboard",nodes:[{id:"dashboard",label:"Dashboard",icon:"ðŸ“Š"},{id:"analytics",label:"Analytics",icon:"ðŸ“ˆ"},{id:"reports",label:"Reports",icon:"ðŸ“„"},{id:"settings",label:"Settings",icon:"âš™ï¸"},{id:"billing",label:"Billing",icon:"ðŸ’°"},{id:"team",label:"Team",icon:"ðŸ‘¥"},{id:"profile",label:"Profile",icon:"ðŸ‘¤"}],transitions:[{from:"dashboard",to:"analytics",weight:2,actor:"user"},{from:"dashboard",to:"reports",weight:1,actor:"user"},{from:"dashboard",to:"settings",weight:1,actor:"user"},{from:"dashboard",to:"billing",weight:1,actor:"user"},{from:"dashboard",to:"team",weight:1,actor:"user"},{from:"analytics",to:"dashboard",weight:1,actor:"user"},{from:"analytics",to:"reports",weight:2,actor:"user"},{from:"reports",to:"dashboard",weight:1,actor:"user"},{from:"reports",to:"analytics",weight:1,actor:"user"},{from:"settings",to:"dashboard",weight:1,actor:"user"},{from:"settings",to:"profile",weight:2,actor:"user"},{from:"settings",to:"billing",weight:1,actor:"user"},{from:"profile",to:"settings",weight:1,actor:"user"},{from:"profile",to:"dashboard",weight:1,actor:"user"},{from:"billing",to:"dashboard",weight:1,actor:"user"},{from:"billing",to:"settings",weight:1,actor:"user"},{from:"team",to:"dashboard",weight:1,actor:"user"},{from:"team",to:"settings",weight:1,actor:"user"}],preloadRecords:[{from:"dashboard",to:"analytics",actor:"user",count:200},{from:"analytics",to:"reports",actor:"user",count:120},{from:"dashboard",to:"billing",actor:"user",count:80},{from:"settings",to:"profile",actor:"user",count:60},{from:"analytics",to:"dashboard",actor:"user",count:150}]},{id:"support",name:"Support Ticketing",icon:"ðŸŽ«",description:"Ticket lifecycle from creation to closure",startNode:"new_ticket",nodes:[{id:"new_ticket",label:"New Ticket",icon:"ðŸ“"},{id:"triage",label:"Triage",icon:"ðŸ”"},{id:"assigned",label:"Assigned",icon:"ðŸ‘¤"},{id:"in_progress",label:"In Progress",icon:"ðŸ”§"},{id:"waiting",label:"Waiting Response",icon:"â³"},{id:"escalated",label:"Escalated",icon:"âš ï¸"},{id:"resolved",label:"Resolved",icon:"âœ…"},{id:"closed",label:"Closed",icon:"ðŸ“"}],transitions:[{from:"new_ticket",to:"triage",weight:2,actor:"system"},{from:"triage",to:"assigned",weight:2,actor:"user"},{from:"triage",to:"assigned",weight:1,actor:"automation"},{from:"assigned",to:"in_progress",weight:2,actor:"user"},{from:"in_progress",to:"waiting",weight:1,actor:"user"},{from:"in_progress",to:"escalated",weight:1,actor:"user"},{from:"in_progress",to:"resolved",weight:2,actor:"user"},{from:"waiting",to:"resolved",weight:2,actor:"user"},{from:"waiting",to:"closed",weight:1,actor:"system"},{from:"escalated",to:"resolved",weight:2,actor:"user"},{from:"resolved",to:"closed",weight:2,actor:"user"},{from:"resolved",to:"closed",weight:1,actor:"automation"}],preloadRecords:[{from:"new_ticket",to:"triage",actor:"system",count:500},{from:"triage",to:"assigned",actor:"automation",count:450},{from:"assigned",to:"in_progress",actor:"user",count:400},{from:"in_progress",to:"resolved",actor:"user",count:350},{from:"resolved",to:"closed",actor:"automation",count:340},{from:"in_progress",to:"escalated",actor:"user",count:30}]},{id:"onboarding",name:"User Onboarding",icon:"ðŸš€",description:"New user onboarding from welcome to completion",startNode:"welcome",nodes:[{id:"welcome",label:"Welcome",icon:"ðŸ‘‹"},{id:"create_account",label:"Create Account",icon:"ðŸ“"},{id:"verify_email",label:"Verify Email",icon:"ðŸ“§"},{id:"setup_profile",label:"Setup Profile",icon:"ðŸ‘¤"},{id:"preferences",label:"Preferences",icon:"âš™ï¸"},{id:"tutorial",label:"Tutorial",icon:"ðŸ“š"},{id:"complete",label:"Complete!",icon:"ðŸŽ‰"}],transitions:[{from:"welcome",to:"create_account",weight:2,actor:"user"},{from:"create_account",to:"verify_email",weight:2,actor:"user"},{from:"verify_email",to:"setup_profile",weight:2,actor:"user"},{from:"setup_profile",to:"preferences",weight:2,actor:"user"},{from:"preferences",to:"tutorial",weight:2,actor:"user"},{from:"preferences",to:"complete",weight:1,actor:"user"},{from:"tutorial",to:"complete",weight:2,actor:"user"},{from:"create_account",to:"setup_profile",weight:1,actor:"user"},{from:"setup_profile",to:"complete",weight:1,actor:"user"}],preloadRecords:[{from:"welcome",to:"create_account",actor:"user",count:1e3},{from:"create_account",to:"verify_email",actor:"user",count:900},{from:"verify_email",to:"setup_profile",actor:"user",count:800},{from:"setup_profile",to:"preferences",actor:"user",count:750},{from:"preferences",to:"tutorial",actor:"user",count:500},{from:"preferences",to:"complete",actor:"user",count:200},{from:"tutorial",to:"complete",actor:"user",count:480}]}],d={activeScenario:P[0],currentNode:P[0].startNode,sessionId:"",transitionHistory:[],predictions:[],detailedPrediction:void 0,engagementState:"active",activeTime:0,idleTime:0,actorMode:"user",showAnalysis:!1,analysisResults:{loops:[],bottlenecks:[],opportunities:[]}};let w=V({transitions:d.activeScenario.transitions,validateOnCreate:!0}),T=B(w,{decayAlgorithm:"ewma",decayFactor:.9,coldStart:d.activeScenario.preloadRecords?{strategy:"preload",warmupThreshold:50,preloadRecords:d.activeScenario.preloadRecords}:{strategy:"procedural-weight",warmupThreshold:50}}),S=j(w,T,{validateTransitions:!0,trackSessions:!0}),W=z(w),C=G(w,T);const N=It({idleThreshold:1e4,awayThreshold:3e4,onEngagementChange:(n,t)=>{d.engagementState=n,Pt(n,t)}}),_=Dt({maxRecentEvents:10,includePatterns:!0,includeDwell:!0,getNodeLabel:n=>d.activeScenario.nodes.find(e=>e.id===n)?.label??n});let k=S.startSession("user");d.sessionId=k.id;N.enterNode(d.currentNode);function Mt(n){const t=P.find(e=>e.id===n);t&&(S.destroy(),T.destroy(),w.destroy(),W.destroy(),C.destroy(),d.activeScenario=t,d.currentNode=t.startNode,d.transitionHistory=[],d.showAnalysis=!1,w=V({transitions:t.transitions,validateOnCreate:!0}),T=B(w,{decayAlgorithm:"ewma",decayFactor:.9,coldStart:t.preloadRecords?{strategy:"preload",warmupThreshold:50,preloadRecords:t.preloadRecords}:{strategy:"procedural-weight",warmupThreshold:50}}),S=j(w,T,{validateTransitions:!0,trackSessions:!0}),W=z(w),C=G(w,T),k=S.startSession("user"),d.sessionId=k.id,N.exitNode(),N.enterNode(d.currentNode),A())}function Pt(n,t){const e=document.getElementById("engagement-state");e&&(e.textContent=`${Y(n)} ${n.toUpperCase()}`,e.className=`engagement-badge ${n}`);const s=N.getCurrentDwell();s&&(d.activeTime=s.activeTime,d.idleTime=s.idleTime,K()),console.log(`Engagement changed to ${n} on ${t}`)}function K(){const n=document.getElementById("active-time"),t=document.getElementById("idle-time");n&&(n.textContent=O(d.activeTime)),t&&(t.textContent=O(d.idleTime))}function Y(n){switch(n){case"active":return"ðŸŸ¢";case"idle":return"ðŸŸ¡";case"away":return"ðŸ”´";default:return"âšª"}}function O(n){return n<1e3?`${n}ms`:n<6e4?`${(n/1e3).toFixed(1)}s`:`${(n/6e4).toFixed(1)}m`}function A(){const n=document.getElementById("app");if(!n)return;d.detailedPrediction=S.predictNextDetailed(d.currentNode,{actor:d.actorMode,sessionId:d.sessionId,path:`/${d.currentNode}`,count:5}),d.predictions=d.detailedPrediction.predictions;const t=S.getValidTransitions(d.currentNode),e=w.getStats(),s=T.getStats(),i=d.activeScenario.nodes.find(o=>o.id===d.currentNode);n.innerHTML=`
		<div class="container">
			<header>
				<h1>ðŸ”„ ActionLoop Showcase</h1>
				<p class="subtitle">Predictive Procedural Action Loop System â€” Real-World Examples</p>
			</header>

			\x3C!-- Scenario Tabs -->
			<nav class="scenario-tabs">
				${P.map(o=>`
					<button
						class="scenario-tab ${o.id===d.activeScenario.id?"active":""}"
						data-scenario="${o.id}"
					>
						<span class="tab-icon">${o.icon}</span>
						<span class="tab-name">${o.name}</span>
					</button>
				`).join("")}
			</nav>

			<div class="scenario-description">
				<strong>${d.activeScenario.icon} ${d.activeScenario.name}</strong>
				<span>${d.activeScenario.description}</span>
			</div>

			<div class="grid">
				\x3C!-- Current State & Engagement -->
				<section class="card current-state">
					<h2>ðŸ“ Current Location</h2>
					<div class="state-display">
						<span class="node-icon">${i?.icon??"ðŸ“"}</span>
						<span class="node-badge current">${i?.label??d.currentNode}</span>
					</div>
					<div class="engagement-info">
						<div class="engagement-row">
							<span class="label">Engagement:</span>
							<span id="engagement-state" class="engagement-badge ${d.engagementState}">
								${Y(d.engagementState)} ${d.engagementState.toUpperCase()}
							</span>
						</div>
						<div class="dwell-stats">
							<div class="dwell-stat">
								<span class="dwell-label">Active:</span>
								<span id="active-time" class="dwell-value">${O(d.activeTime)}</span>
							</div>
							<div class="dwell-stat">
								<span class="dwell-label">Idle:</span>
								<span id="idle-time" class="dwell-value">${O(d.idleTime)}</span>
							</div>
						</div>
					</div>
					<div class="session-info">
						<small>Session: ${d.sessionId.slice(0,8)}...</small>
					</div>
				</section>

				\x3C!-- Predictions with Confidence -->
				<section class="card predictions">
					<h2>ðŸ”® AI Predictions</h2>
					<div class="warmup-status ${d.detailedPrediction?.warmupComplete?"warm":"cold"}">
						${d.detailedPrediction?.warmupComplete?"âœ… Predictions are reliable (warm)":`â³ Warming up (${d.detailedPrediction?.transitionCount??0}/50 transitions)`}
					</div>
					<div class="prediction-list">
						${d.predictions.length>0?d.predictions.map((o,r)=>kt(o,r)).join(""):'<p class="empty">No predictions (end node or cold start)</p>'}
					</div>
				</section>

				\x3C!-- Actor Mode Selection -->
				<section class="card actor-mode">
					<h2>ðŸ‘¤ Actor Mode</h2>
					<p class="description">Select who is performing actions:</p>
					<div class="actor-buttons">
						<button class="actor-btn ${d.actorMode==="user"?"active":""}" data-actor="user">
							ðŸ‘¤ User
						</button>
						<button class="actor-btn ${d.actorMode==="system"?"active":""}" data-actor="system">
							âš™ï¸ System
						</button>
						<button class="actor-btn ${d.actorMode==="automation"?"active":""}" data-actor="automation">
							ðŸ¤– Automation
						</button>
					</div>
					<div class="actor-description">
						${_t(d.actorMode)}
					</div>
				</section>

				\x3C!-- Valid Actions Grid -->
				<section class="card valid-actions">
					<h2>âœ… Available Actions</h2>
					<p class="description">All valid transitions from current location:</p>
					<div class="action-grid">
						${t.map(o=>{const r=d.activeScenario.nodes.find(l=>l.id===o.to),c=d.predictions.find(l=>l.nodeId===o.to);return`
								<button class="action-card" data-target="${o.to}">
									<span class="action-icon">${r?.icon??"ðŸ“"}</span>
									<span class="action-name">${r?.label??o.to}</span>
									<span class="action-actor">${J(o.actor)}</span>
									${c?`<span class="action-confidence">${Math.round(c.confidence*100)}%</span>`:""}
								</button>
							`}).join("")}
					</div>
				</section>

				\x3C!-- Transition History -->
				<section class="card history">
					<h2>ðŸ“œ Journey History</h2>
					<div class="history-list">
						${d.transitionHistory.length>0?d.transitionHistory.slice(-8).reverse().map(Ot).join(""):'<p class="empty">No transitions recorded yet. Click an action to start!</p>'}
					</div>
				</section>

				\x3C!-- Graph Statistics -->
				<section class="card stats">
					<h2>ðŸ“ˆ Graph Statistics</h2>
					<div class="stats-grid">
						<div class="stat">
							<span class="value">${e.nodeCount}</span>
							<span class="label">Nodes</span>
						</div>
						<div class="stat">
							<span class="value">${e.transitionCount}</span>
							<span class="label">Transitions</span>
						</div>
						<div class="stat">
							<span class="value">${s.totalWeightUpdates}</span>
							<span class="label">Weight Updates</span>
						</div>
						<div class="stat highlight">
							<span class="value">${s.warmupComplete?"âœ“":"..."}</span>
							<span class="label">Warm Status</span>
						</div>
					</div>
					<div class="actor-stats">
						<span class="actor-stat">ðŸ‘¤ User: ${e.actorCounts.user}</span>
						<span class="actor-stat">âš™ï¸ System: ${e.actorCounts.system}</span>
						<span class="actor-stat">ðŸ¤– Auto: ${e.actorCounts.automation}</span>
					</div>
				</section>
			</div>

			\x3C!-- Workflow Visualization -->
			<section class="card workflow-viz">
				<h2>ðŸ—ºï¸ Workflow Map</h2>
				<div class="workflow-nodes">
					${d.activeScenario.nodes.map(o=>`
						<div class="workflow-node ${o.id===d.currentNode?"current":""} ${d.predictions.some(r=>r.nodeId===o.id)?"predicted":""}">
							<span class="wf-icon">${o.icon}</span>
							<span class="wf-label">${o.label}</span>
						</div>
					`).join("")}
				</div>
			</section>

			\x3C!-- Tools Section -->
			<section class="card tools">
				<h2>ðŸ› ï¸ Developer Tools</h2>
				<div class="tool-buttons">
					<button id="btn-validate">ðŸ” Validate Graph</button>
					<button id="btn-analyze">ðŸ“Š Analyze Patterns</button>
					<button id="btn-context">ðŸ¤– LLM Context</button>
					<button id="btn-export">ðŸ“¦ Export Weights</button>
					<button id="btn-builder">ðŸ—ï¸ Builder Demo</button>
					<button id="btn-reset">ðŸ”„ Reset Session</button>
				</div>
				<div id="tool-output" class="tool-output"></div>
			</section>

			\x3C!-- Analysis Results (shown when analysis is run) -->
			${d.showAnalysis?Rt():""}

			<footer>
				<p>@mikesaintsg/actionloop â€” Zero dependency workflow prediction engine</p>
				<p class="footer-stats">
					${d.transitionHistory.length} transitions recorded â€¢
					${d.predictions.length} predictions available â€¢
					${d.detailedPrediction?.transitionCount??0} total weight updates
				</p>
			</footer>
		</div>
	`,Wt()}function kt(n,t){const e=d.activeScenario.nodes.find(o=>o.id===n.nodeId),s=Math.round(n.confidence*100),i=s>=70?"high":s>=40?"medium":"low";return`
		<button class="prediction-btn" data-target="${n.nodeId}">
			<span class="rank">${t+1}</span>
			<span class="pred-icon">${e?.icon??"ðŸ“"}</span>
			<span class="pred-info">
				<span class="pred-name">${e?.label??n.nodeId}</span>
				<span class="pred-factors">
					Score: ${n.score.toFixed(2)} â€¢ Base: ${n.baseWeight.toFixed(1)} â€¢ Predictive: ${n.predictiveWeight.toFixed(2)}
				</span>
			</span>
			<span class="confidence-bar ${i}">
				<span class="confidence-fill" style="width: ${s}%"></span>
				<span class="confidence-text">${s}%</span>
			</span>
		</button>
	`}function Ot(n){const t=d.activeScenario.nodes.find(s=>s.id===n.from),e=d.activeScenario.nodes.find(s=>s.id===n.to);return`
		<div class="history-item">
			<span class="from">${t?.icon??""} ${t?.label??n.from}</span>
			<span class="arrow">â†’</span>
			<span class="to">${e?.icon??""} ${e?.label??n.to}</span>
			<span class="actor-badge ${n.actor}">${J(n.actor)}</span>
			<span class="time">${n.time.toLocaleTimeString()}</span>
		</div>
	`}function Rt(){return`
		<section class="card analysis-results">
			<h2>ðŸ“Š Workflow Analysis</h2>
			<div class="analysis-grid">
				<div class="analysis-section">
					<h3>ðŸ”„ Hot Loops (${d.analysisResults.loops.length})</h3>
					${d.analysisResults.loops.length>0?d.analysisResults.loops.map(n=>`
							<div class="analysis-item loop">
								<span class="loop-type">${n.loopType}</span>
								<span class="loop-nodes">${n.nodes.join(" â†’ ")}</span>
								<span class="loop-freq">Freq: ${n.frequency.toFixed(1)}</span>
							</div>
						`).join(""):'<p class="empty">No hot loops detected</p>'}
				</div>
				<div class="analysis-section">
					<h3>âš ï¸ Bottlenecks (${d.analysisResults.bottlenecks.length})</h3>
					${d.analysisResults.bottlenecks.length>0?d.analysisResults.bottlenecks.map(n=>`
							<div class="analysis-item bottleneck">
								<span class="bn-node">${n.nodeId}</span>
								<span class="bn-traffic">In: ${n.incomingTraffic.toFixed(0)} / Out: ${n.outgoingTraffic.toFixed(0)}</span>
								<span class="bn-congestion">Congestion: ${n.congestionScore.toFixed(1)}x</span>
							</div>
						`).join(""):'<p class="empty">No bottlenecks detected</p>'}
				</div>
				<div class="analysis-section">
					<h3>ðŸ¤– Automation Opportunities (${d.analysisResults.opportunities.length})</h3>
					${d.analysisResults.opportunities.length>0?d.analysisResults.opportunities.map(n=>`
							<div class="analysis-item opportunity">
								<span class="opp-type">${n.automationType}</span>
								<span class="opp-sequence">${n.sequence.join(" â†’ ")}</span>
								<span class="opp-confidence">Confidence: ${Math.round(n.confidence*100)}%</span>
							</div>
						`).join(""):'<p class="empty">No automation opportunities detected</p>'}
				</div>
			</div>
		</section>
	`}function _t(n){switch(n){case"user":return"Human-initiated actions (clicks, form submissions)";case"system":return"Platform-triggered events (timeouts, errors, notifications)";case"automation":return"Robotic/LLM-triggered workflows (scheduled tasks, bots)";default:return""}}function J(n){switch(n){case"user":return"ðŸ‘¤";case"system":return"âš™ï¸";case"automation":return"ðŸ¤–";default:return"â“"}}function Wt(){document.querySelectorAll("[data-scenario]").forEach(n=>{n.addEventListener("click",t=>{const e=t.currentTarget.dataset.scenario;e&&Mt(e)})}),document.querySelectorAll("[data-target]").forEach(n=>{n.addEventListener("click",t=>{const e=t.currentTarget.dataset.target;e&&xt(e)})}),document.querySelectorAll("[data-actor]").forEach(n=>{n.addEventListener("click",t=>{const e=t.currentTarget.dataset.actor;e&&(d.actorMode=e,A())})}),document.getElementById("btn-validate")?.addEventListener("click",()=>{const n=W.runStaticChecks(),t=document.getElementById("tool-output");t&&(n.length===0?t.innerHTML='<div class="success">âœ… Graph is valid! No structural issues found.</div>':t.innerHTML=`
					<div class="info">ðŸ” Validation Results: ${n.length} issue(s) found</div>
					${n.map(e=>`<div class="${e.severity}">
							${e.severity==="error"?"âŒ":e.severity==="warning"?"âš ï¸":"â„¹ï¸"}
							[${e.severity.toUpperCase()}] ${e.message}
							${e.suggestion?`<br><small>ðŸ’¡ ${e.suggestion}</small>`:""}
						</div>`).join("")}
				`)}),document.getElementById("btn-analyze")?.addEventListener("click",()=>{const n=C.findHotLoops(),t=C.findBottlenecks(),e=C.findAutomationOpportunities(),s=C.findStronglyConnectedComponents(),i=C.getSummary();d.analysisResults={loops:n,bottlenecks:t,opportunities:e},d.showAnalysis=!0;const o=document.getElementById("tool-output");o&&(o.innerHTML=`
				<div class="success">ðŸ“Š Analysis complete! Scroll down to see detailed results.</div>
				<div class="info">
					<strong>Summary:</strong><br>
					â€¢ ${n.length} hot loop(s) detected<br>
					â€¢ ${t.length} bottleneck(s) identified<br>
					â€¢ ${e.length} automation opportunit(ies)<br>
					â€¢ ${s.length} strongly connected component(s)<br>
					â€¢ Average path length: ${i.avgPathLength.toFixed(2)}
				</div>
			`),A()}),document.getElementById("btn-context")?.addEventListener("click",()=>{const n=S.predictNextDetailed(d.currentNode,{actor:d.actorMode,sessionId:d.sessionId,path:`/${d.currentNode}`,count:5}),t=d.transitionHistory.slice(-10).map((r,c)=>({id:`event-${c}`,sessionId:d.sessionId,actor:r.actor,from:r.from,to:r.to,path:`/${r.to}`,timestamp:r.time.getTime(),dwell:{nodeId:r.from,enterTime:r.time.getTime()-5e3,exitTime:r.time.getTime(),activeTime:4e3,idleTime:1e3,engagement:"active",engagementScore:.8},engagement:"active"})),e=_.format(n,t),s=_.toNaturalLanguage(e),i=_.toJSON(e),o=document.getElementById("tool-output");o&&(o.innerHTML=`
				<div class="success">ðŸ¤– LLM Context Generated!</div>
				<div class="info"><strong>Natural Language (for system prompts):</strong></div>
				<pre>${I(s)}</pre>
				<div class="info"><strong>JSON Context (for tool integration):</strong></div>
				<pre>${I(i.slice(0,800))}${i.length>800?`
... (truncated)`:""}</pre>
			`)}),document.getElementById("btn-export")?.addEventListener("click",()=>{const n=T.export(),t=document.getElementById("tool-output");if(t){const e=JSON.stringify(n,null,2);t.innerHTML=`
				<div class="success">ðŸ“¦ Exported predictive graph weights</div>
				<div class="info">
					â€¢ Model ID: ${n.modelId}<br>
					â€¢ ${n.weights.length} weight entries<br>
					â€¢ Total transitions: ${n.transitionCount}<br>
					â€¢ Warmup threshold: ${n.warmupThreshold}<br>
					â€¢ Decay: ${n.decayConfig.algorithm} (factor: ${n.decayConfig.decayFactor})
				</div>
				<pre>${I(e.slice(0,1e3))}${e.length>1e3?`
... (truncated)`:""}</pre>
			`}}),document.getElementById("btn-builder")?.addEventListener("click",()=>{Ft()}),document.getElementById("btn-reset")?.addEventListener("click",()=>{try{S.endSession(d.sessionId,"abandoned")}catch{}N.exitNode(),N.clearHistory();const n=S.startSession("user");d.sessionId=n.id,d.currentNode=d.activeScenario.startNode,d.transitionHistory=[],d.activeTime=0,d.idleTime=0,d.showAnalysis=!1,T.clear(),d.activeScenario.preloadRecords&&T.preload(d.activeScenario.preloadRecords),N.enterNode(d.currentNode),A();const t=document.getElementById("tool-output");t&&(t.innerHTML='<div class="success">ðŸ”„ Session reset! Starting fresh with preloaded patterns.</div>')})}function I(n){const t=document.createElement("div");return t.textContent=n,t.innerHTML}function xt(n){const t=d.currentNode,s=S.getValidTransitions(t).find(o=>o.to===n);if(!s){const o=document.getElementById("tool-output");o&&(o.innerHTML=`<div class="error">âŒ Invalid transition: ${t} â†’ ${n}</div>`);return}const i=s.actor;try{const o=N.exitNode();o&&(d.activeTime=o.activeTime,d.idleTime=o.idleTime),S.recordTransition(t,n,{actor:i,sessionId:d.sessionId,path:`/${n}`}),d.transitionHistory.push({from:t,to:n,time:new Date,actor:i}),d.currentNode=n,N.enterNode(n),A()}catch(o){const r=document.getElementById("tool-output");if(r){const c=o instanceof Error?o.message:"Unknown error";r.innerHTML=`<div class="error">âŒ Transition failed: ${c}</div>`}}}function Ft(){const n=Lt({validateOnChange:!0,onNodeAdded:o=>console.log("Node added:",o.id),onTransitionAdded:o=>console.log("Transition added:",`${o.from} â†’ ${o.to}`)});n.addNode({id:"draft",label:"Draft"}).addNode({id:"submitted",label:"Submitted"}).addNode({id:"review",label:"Under Review"}).addNode({id:"approved",label:"Approved"}).addNode({id:"rejected",label:"Rejected"}).addTransition({from:"draft",to:"submitted",weight:1,actor:"user"}).addTransition({from:"submitted",to:"review",weight:1,actor:"system"}).addTransition({from:"review",to:"approved",weight:2,actor:"user"}).addTransition({from:"review",to:"rejected",weight:1,actor:"user"}).addTransition({from:"rejected",to:"draft",weight:1,actor:"user"}).addProcedure({id:"approval-flow",actions:["draft","submitted","review","approved"]});const t=n.validate(),e=n.toJSON(),s=n.toYAML(),i=document.getElementById("tool-output");if(i&&(i.innerHTML=`
			<div class="success">ðŸ—ï¸ Builder Demo: Approval Workflow Created!</div>
			<div class="info">
				<strong>Validation:</strong> ${t.valid?"âœ… Valid":"âŒ Invalid"}<br>
				â€¢ Nodes: ${n.getNodes().length}<br>
				â€¢ Transitions: ${n.getTransitions().length}<br>
				â€¢ Procedures: ${n.getProcedures().length}<br>
				${t.errors.length>0?`â€¢ Errors: ${t.errors.length}`:""}
				${t.warnings.length>0?`â€¢ Warnings: ${t.warnings.length}`:""}
			</div>
			<div class="info"><strong>JSON Export:</strong></div>
			<pre>${I(e.slice(0,600))}${e.length>600?`
...`:""}</pre>
			<div class="info"><strong>YAML Export:</strong></div>
			<pre>${I(s.slice(0,400))}${s.length>400?`
...`:""}</pre>
		`),t.valid){const o=n.build();console.log("Built graph stats:",o.getStats()),o.destroy()}n.destroy()}setInterval(()=>{const n=N.getCurrentDwell();n&&(d.activeTime=n.activeTime,d.idleTime=n.idleTime,K())},1e3);document.addEventListener("DOMContentLoaded",()=>{A(),console.log("ðŸ”„ ActionLoop Showcase initialized"),console.log("ðŸ“Š Active scenario:",d.activeScenario.name),console.log("ðŸ“ˆ Procedural graph stats:",w.getStats()),console.log("ðŸŽ¯ Session started:",k.id),console.log("ðŸ”® Warmup status:",T.isWarmupComplete()?"Complete":"In progress")});</script>
  <style rel="stylesheet" crossorigin>:root{--color-bg: #0d1117;--color-surface: #161b22;--color-border: #30363d;--color-text: #c9d1d9;--color-text-muted: #8b949e;--color-primary: #58a6ff;--color-success: #3fb950;--color-warning: #d29922;--color-error: #f85149;--color-accent: #a371f7;--color-user: #58a6ff;--color-system: #d29922;--color-automation: #a371f7;--radius: 8px;--shadow: 0 8px 24px rgba(0, 0, 0, .3)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,sans-serif;background:var(--color-bg);color:var(--color-text);line-height:1.6;min-height:100vh}.container{max-width:1400px;margin:0 auto;padding:2rem}header{text-align:center;margin-bottom:1.5rem}header h1{font-size:2.5rem;margin-bottom:.5rem;background:linear-gradient(135deg,var(--color-primary),var(--color-accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.subtitle{color:var(--color-text-muted);font-size:1.1rem}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:1.5rem;margin-bottom:2rem}.scenario-tabs{display:flex;gap:.5rem;margin-bottom:1rem;overflow-x:auto;padding-bottom:.5rem}.scenario-tab{display:flex;align-items:center;gap:.5rem;padding:.75rem 1.25rem;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius);color:var(--color-text);cursor:pointer;transition:all .2s ease;white-space:nowrap}.scenario-tab:hover{border-color:var(--color-primary);background:#58a6ff1a}.scenario-tab.active{background:linear-gradient(135deg,var(--color-primary),var(--color-accent));border-color:transparent;color:#fff}.tab-icon{font-size:1.25rem}.tab-name{font-weight:500}.scenario-description{background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius);padding:1rem;margin-bottom:1.5rem;display:flex;gap:1rem;align-items:center}.scenario-description strong{white-space:nowrap}.scenario-description span{color:var(--color-text-muted)}.card{background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow)}.card h2{font-size:1.25rem;margin-bottom:1rem;color:var(--color-text);display:flex;align-items:center;gap:.5rem}.card .description{color:var(--color-text-muted);font-size:.875rem;margin-bottom:1rem}.current-state .state-display{display:flex;justify-content:center;align-items:center;gap:1rem;margin:1.5rem 0}.node-icon{font-size:2rem}.node-badge{background:var(--color-border);padding:.5rem 1.5rem;border-radius:var(--radius);font-size:1.25rem;font-weight:600}.node-badge.current{background:linear-gradient(135deg,var(--color-primary),var(--color-accent));color:#fff}.engagement-info{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--color-border)}.engagement-row{display:flex;justify-content:center;align-items:center;gap:.75rem;margin-bottom:.75rem}.engagement-badge{padding:.25rem .75rem;border-radius:var(--radius);font-size:.75rem;font-weight:600;text-transform:uppercase}.engagement-badge.active{background:#3fb95033;color:var(--color-success)}.engagement-badge.idle{background:#d2992233;color:var(--color-warning)}.engagement-badge.away{background:#f8514933;color:var(--color-error)}.engagement-badge.unknown{background:#8b949e33;color:var(--color-text-muted)}.dwell-stats{display:flex;justify-content:center;gap:2rem}.dwell-stat{display:flex;flex-direction:column;align-items:center;gap:.25rem}.dwell-label{font-size:.75rem;color:var(--color-text-muted)}.dwell-value{font-weight:600;font-family:SF Mono,Monaco,monospace}.session-info{text-align:center;color:var(--color-text-muted);margin-top:1rem}.warmup-status{padding:.5rem 1rem;border-radius:var(--radius);font-size:.875rem;margin-bottom:1rem;text-align:center}.warmup-status.warm{background:#3fb95026;color:var(--color-success);border:1px solid rgba(63,185,80,.3)}.warmup-status.cold{background:#d2992226;color:var(--color-warning);border:1px solid rgba(210,153,34,.3)}.prediction-list{display:flex;flex-direction:column;gap:.5rem}.prediction-btn{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:var(--color-bg);border:1px solid var(--color-border);border-radius:var(--radius);color:var(--color-text);cursor:pointer;transition:all .2s ease;text-align:left}.prediction-btn:hover{border-color:var(--color-primary);background:#58a6ff1a}.prediction-btn .rank{background:var(--color-primary);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;flex-shrink:0}.prediction-btn .pred-icon{font-size:1.25rem;flex-shrink:0}.prediction-btn .pred-info{flex:1;min-width:0}.prediction-btn .pred-name{font-weight:500;display:block}.prediction-btn .pred-factors{font-size:.7rem;color:var(--color-text-muted);display:block}.confidence-bar{position:relative;width:60px;height:20px;background:var(--color-border);border-radius:4px;overflow:hidden;flex-shrink:0}.confidence-fill{position:absolute;top:0;left:0;height:100%;border-radius:4px;transition:width .3s ease}.confidence-bar.high .confidence-fill{background:var(--color-success)}.confidence-bar.medium .confidence-fill{background:var(--color-warning)}.confidence-bar.low .confidence-fill{background:var(--color-text-muted)}.confidence-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.65rem;font-weight:600;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5)}.actor-buttons{display:flex;gap:.5rem;margin-bottom:1rem}.actor-btn{flex:1;padding:.5rem;background:var(--color-bg);border:1px solid var(--color-border);border-radius:var(--radius);color:var(--color-text);cursor:pointer;transition:all .2s ease;font-size:.875rem}.actor-btn:hover{border-color:var(--color-primary)}.actor-btn.active{background:var(--color-primary);border-color:var(--color-primary);color:#fff}.actor-description{font-size:.8rem;color:var(--color-text-muted);text-align:center;padding:.5rem;background:var(--color-bg);border-radius:var(--radius)}.action-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.75rem}.action-card{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:1rem .75rem;background:var(--color-bg);border:1px solid var(--color-border);border-radius:var(--radius);color:var(--color-text);cursor:pointer;transition:all .2s ease;position:relative}.action-card:hover{border-color:var(--color-success);background:#3fb9501a;transform:translateY(-2px)}.action-icon{font-size:1.5rem}.action-name{font-size:.8rem;font-weight:500;text-align:center}.action-actor{font-size:.75rem}.action-confidence{position:absolute;top:4px;right:4px;background:var(--color-success);color:#fff;padding:.125rem .375rem;border-radius:4px;font-size:.65rem;font-weight:600}.action-list{display:flex;flex-wrap:wrap;gap:.5rem}.action-btn{padding:.5rem 1rem;background:var(--color-bg);border:1px solid var(--color-border);border-radius:var(--radius);color:var(--color-text);cursor:pointer;transition:all .2s ease}.action-btn:hover{border-color:var(--color-success);background:#3fb9501a}.history-list{display:flex;flex-direction:column;gap:.5rem;max-height:300px;overflow-y:auto}.history-item{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;background:var(--color-bg);border-radius:var(--radius);font-size:.875rem}.history-item .from,.history-item .to{font-weight:500}.history-item .arrow{color:var(--color-text-muted)}.history-item .actor-badge{padding:.125rem .375rem;border-radius:4px;font-size:.7rem}.history-item .actor-badge.user{background:#58a6ff33}.history-item .actor-badge.system{background:#d2992233}.history-item .actor-badge.automation{background:#a371f733}.history-item .time{margin-left:auto;color:var(--color-text-muted);font-size:.75rem;font-family:SF Mono,Monaco,monospace}.workflow-viz{grid-column:1 / -1}.workflow-nodes{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center;padding:1rem;background:var(--color-bg);border-radius:var(--radius)}.workflow-node{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:.75rem 1rem;background:var(--color-surface);border:2px solid var(--color-border);border-radius:var(--radius);transition:all .2s ease}.workflow-node.current{border-color:var(--color-primary);background:#58a6ff26;box-shadow:0 0 12px #58a6ff4d}.workflow-node.predicted{border-color:var(--color-success);border-style:dashed}.workflow-node.current.predicted{border-style:solid}.wf-icon{font-size:1.25rem}.wf-label{font-size:.75rem;font-weight:500}.graph-display{padding:1rem;background:var(--color-bg);border-radius:var(--radius)}.graph-nodes{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}.graph-node{padding:.25rem .75rem;background:var(--color-border);border-radius:var(--radius);font-size:.875rem}.graph-node.active{background:var(--color-primary);color:#fff}.graph-edges{display:flex;flex-wrap:wrap;gap:.5rem}.graph-edge{padding:.25rem .5rem;background:transparent;border:1px dashed var(--color-border);border-radius:var(--radius);font-size:.75rem;color:var(--color-text-muted)}.analysis-results{grid-column:1 / -1;margin-top:1rem}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.analysis-section{background:var(--color-bg);border-radius:var(--radius);padding:1rem}.analysis-section h3{font-size:1rem;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--color-border)}.analysis-item{padding:.5rem;margin-bottom:.5rem;background:var(--color-surface);border-radius:4px;font-size:.8rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}.analysis-item.loop{border-left:3px solid var(--color-warning)}.analysis-item.bottleneck{border-left:3px solid var(--color-error)}.analysis-item.opportunity{border-left:3px solid var(--color-success)}.loop-type,.opp-type{padding:.125rem .375rem;background:var(--color-border);border-radius:4px;font-size:.7rem;text-transform:uppercase}.loop-nodes,.opp-sequence{flex:1;color:var(--color-text-muted)}.loop-freq,.bn-congestion,.opp-confidence{font-weight:600;color:var(--color-primary)}.bn-node{font-weight:500}.bn-traffic{color:var(--color-text-muted)}.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1rem}.stat{text-align:center;padding:1rem;background:var(--color-bg);border-radius:var(--radius)}.stat.highlight{background:linear-gradient(135deg,#58a6ff1a,#a371f71a);border:1px solid var(--color-border)}.stat .value{display:block;font-size:1.75rem;font-weight:600;color:var(--color-primary)}.stat .label{font-size:.7rem;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:.05em}.actor-stats{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}.actor-stat{font-size:.8rem;color:var(--color-text-muted);padding:.25rem .5rem;background:var(--color-bg);border-radius:4px}.tools{grid-column:1 / -1}.tool-buttons{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem}.tool-buttons button{padding:.5rem 1rem;background:var(--color-primary);border:none;border-radius:var(--radius);color:#fff;font-weight:500;cursor:pointer;transition:all .2s ease}.tool-buttons button:hover{opacity:.9;transform:translateY(-1px)}.tool-output{background:var(--color-bg);border-radius:var(--radius);padding:1rem;min-height:60px;font-family:SF Mono,Monaco,Courier New,monospace;font-size:.875rem}.tool-output .success{color:var(--color-success)}.tool-output .error{color:var(--color-error)}.tool-output .warning{color:var(--color-warning)}.tool-output .info{color:var(--color-text-muted);margin-bottom:.25rem}.tool-output pre{margin-top:.5rem;padding:.5rem;background:var(--color-surface);border-radius:var(--radius);overflow-x:auto;font-size:.75rem}footer{text-align:center;padding:2rem;color:var(--color-text-muted);font-size:.875rem;border-top:1px solid var(--color-border);margin-top:2rem}.footer-stats{font-size:.75rem;margin-top:.5rem;opacity:.7}.empty{color:var(--color-text-muted);font-style:italic;text-align:center;padding:1rem}@media(max-width:768px){.container{padding:1rem}header h1{font-size:1.75rem}.grid{grid-template-columns:1fr}.scenario-tabs{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}.scenario-tab{flex-shrink:0}.scenario-description{flex-direction:column;text-align:center}.stats-grid{grid-template-columns:repeat(4,1fr)}.stat .value{font-size:1.25rem}.actor-buttons{flex-direction:column}.action-grid{grid-template-columns:repeat(2,1fr)}.analysis-grid{grid-template-columns:1fr}.workflow-nodes{gap:.5rem}.workflow-node{padding:.5rem}.wf-label{font-size:.65rem}.tool-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}}</style>
</head>
<body>
<div id="app"></div>
</body>
</html>
